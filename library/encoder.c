#include "encoder.h"
#include "stm32f10x.h"
#include "Delay.h"

/*
  ????:
  1. ??????????,?????+??????,??????
  2. ???????????,????????
  3. ???/????????,??????????
  4. ??????????,?????????????
  5. ??????????,????????????
*/

// ??????(????,?????)
int16_t Encoder_Count = 0;
// ??:??CLK/DT?????,?????????
uint16_t Encoder_CLK_Last = 0;
uint16_t Encoder_DT_Last = 0;
int Encoder_Flag=0;
/*********************************
   @brief:  ??????????
   @param:  void
   @retval: void
*********************************/
void Encoder_Init(void)
{
    GPIO_InitTypeDef GPIO_InitStructure;
    EXTI_InitTypeDef EXTI_InitStructure;
    NVIC_InitTypeDef NVIC_InitStructure;

    // 1. ????
    RCC_APB2PeriphClockCmd(Encoder_GPIO_CLK, ENABLE);        // ??GPIOA??
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);     // ??AFIO??(??????)

    // 2. ??CLK(PA0)?DT(PA1)?SW(PA2)??
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPD;            // ????(?????????,?????)
    GPIO_InitStructure.GPIO_Pin = Encoder_GPIO_PIN_CLK | Encoder_GPIO_PIN_DT | Encoder_GPIO_PIN_SW;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(Encoder_GPIO_PORT, &GPIO_InitStructure);

    // ??:??????,????????(????????????)
    Encoder_CLK_Last = GPIO_ReadInputDataBit(Encoder_GPIO_PORT, Encoder_GPIO_PIN_CLK);
    Encoder_DT_Last = GPIO_ReadInputDataBit(Encoder_GPIO_PORT, Encoder_GPIO_PIN_DT);

    // 3. ????????(AFIO)
    GPIO_EXTILineConfig(Encoder_GPIO_PORT_Source, GPIO_PinSource0); // PA0(CLK) ? EXTI0
    GPIO_EXTILineConfig(Encoder_GPIO_PORT_Source, GPIO_PinSource1); // PA1(DT) ? EXTI1

    // 4. ???EXTI????(??:???+?????)
    EXTI_InitStructure.EXTI_Line = EXTI_Line0 | EXTI_Line1;          // ??EXTI0/EXTI1
    EXTI_InitStructure.EXTI_Mode = EXTI_Mode_Interrupt;              // ????
    EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Rising_Falling;   // ???+?????(??:????????)
    EXTI_InitStructure.EXTI_LineCmd = ENABLE;                        // ?????
    EXTI_Init(&EXTI_InitStructure);

    // 5. ??NVIC???????
    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);  // 2?????? + 2??????

    // 6. ??EXTI0??(CLK??)- ?????,??????
    NVIC_InitStructure.NVIC_IRQChannel = EXTI0_IRQn;                 // ??EXTI0??
    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;        // ???????(??????)
    NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;               // ???????
    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;                  // ????
    NVIC_Init(&NVIC_InitStructure);

    // 7. ??EXTI1??(DT??)
    NVIC_InitStructure.NVIC_IRQChannel = EXTI1_IRQn;                 // ??EXTI1??
    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;        // ???????
    NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;               // ???????EXTI0
    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;                  // ????
    NVIC_Init(&NVIC_InitStructure);
}

/*********************************
   @brief:  EXTI0??????(CLK??PA0)
   @note:   ?????,??????,??????
*********************************/
void EXTI0_IRQHandler(void)
{
    if(EXTI_GetITStatus(EXTI_Line0) == SET)   // ???????
    {
        //Delay_us(20); // ??:20us????,??????
        // ????CLK?DT????
        uint8_t CLK_Cur = GPIO_ReadInputDataBit(Encoder_GPIO_PORT, Encoder_GPIO_PIN_CLK);
        uint8_t DT_Cur = GPIO_ReadInputDataBit(Encoder_GPIO_PORT, Encoder_GPIO_PIN_DT);
				Encoder_Flag =1;
        // ??:??CLK??????????(???????)
        if(CLK_Cur != Encoder_CLK_Last)
        {
            // ????:??CLK??/??????????
            if((CLK_Cur == 1 && DT_Cur == 0) || (CLK_Cur == 0 && DT_Cur == 1))
            {
                Encoder_Count++;  // ??,???+1
            }
            // ????:??CLK??/??????????
            else if((CLK_Cur == 1 && DT_Cur == 1) || (CLK_Cur == 0 && DT_Cur == 0))
            {
                Encoder_Count--;  // ??,???-1
            }
            // ??CLK????,????????
            Encoder_CLK_Last = CLK_Cur;
        }
        
        EXTI_ClearITPendingBit(EXTI_Line0);   // ???????(????,????)
    }
}

/*********************************
   @brief:  EXTI1??????(DT??PA1)
   @note:   ?????,??????,??????
*********************************/
void EXTI1_IRQHandler(void)
{
    if(EXTI_GetITStatus(EXTI_Line1) == SET)   // ???????
    {
        //Delay_us(20); // ??:20us????
        // ????DT?CLK????
        uint16_t DT_Cur = GPIO_ReadInputDataBit(Encoder_GPIO_PORT, Encoder_GPIO_PIN_DT);
        uint16_t CLK_Cur = GPIO_ReadInputDataBit(Encoder_GPIO_PORT, Encoder_GPIO_PIN_CLK);
				Encoder_Flag=1;
        // ??:??DT??????????
        if(DT_Cur != Encoder_DT_Last)
        {
            // ????:??DT??/??????????
            if((DT_Cur == 1 && CLK_Cur == 1) || (DT_Cur == 0 && CLK_Cur == 0))
            {
                Encoder_Count++;  // ??,???+1
            }
            // ????:??DT??/??????????
            else if((DT_Cur == 1 && CLK_Cur == 0) || (DT_Cur == 0 && CLK_Cur == 1))
            {
                Encoder_Count--;  // ??,???-1
            }
            // ??DT????
            Encoder_DT_Last = DT_Cur;
        }
        
        EXTI_ClearITPendingBit(EXTI_Line1);   // ???????
    }
}

/*********************************
   @brief:  ????????(??????)
   @retval: ??????????(int16_t)
*********************************/
int16_t Encoder_Get_Count(void)
{
    int16_t temp;
    
    // ??:?????????(??????,??????????)
    __disable_irq();
    temp = Encoder_Count;  // ??????,?????
    __enable_irq();

    // ??SW??(PA2)??(???????????)
    
    return temp;  // ?????????(???100%)
}
